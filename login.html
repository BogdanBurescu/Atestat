<!DOCTYPE html>
<html>
<head>
    <title>Blackjack Strategy - Login</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script> <!-- Import Firebase Database -->
    <style>
        /* Codul stilizat rămâne același */
    </style>

    <script>
        // Initialize Firebase with your project's config
        var firebaseConfig = {
            apiKey: "AIzaSyBhtw8H7hqFeGyLHTTHDd-VgXk1a9w4Lbo",
            authDomain: "blackyjacky-7ec67.firebaseapp.com",
            projectId: "blackyjacky-7ec67",
            storageBucket: "blackyjacky-7ec67.firebasestorage.app",
            messagingSenderId: "72969183815",
            appId: "1:72969183815:web:2b075f407839a7176d0762",
            measurementId: "G-KVC53GB5TC"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database(); // Initialize Firebase Realtime Database

        // Funcția pentru a genera un ID unic al dispozitivului (folosind localStorage)
        function getDeviceID() {
            if (!localStorage.getItem("deviceID")) {
                // Crează un ID unic folosind timestamp și un număr aleatoriu
                var deviceID = "device-" + new Date().getTime() + Math.floor(Math.random() * 10000);
                localStorage.setItem("deviceID", deviceID);
            }
            return localStorage.getItem("deviceID");
        }

        // Verifică dacă dispozitivul curent este același cu cel salvat în Firebase
        function checkDevice(user) {
            var deviceID = getDeviceID();

            // Verifică dacă utilizatorul are un dispozitiv asociat în Firebase
            var userRef = database.ref('users/' + user.uid);
            userRef.once('value').then(function(snapshot) {
                var storedDeviceID = snapshot.val().deviceID;

                if (storedDeviceID && storedDeviceID !== deviceID) {
                    alert("Acest cont poate fi accesat doar de pe un singur dispozitiv.");
                    firebase.auth().signOut(); // Deconectează utilizatorul
                    window.location.href = "login.html"; // Redirecționează la login
                } else {
                    // Dacă e OK, continuă
                    alert(storedDeviceID);
                    alert(deviceID);
                    window.location.href = "index.html";
                }
            });
        }

        // Funcția de autentificare
        function login() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;
            var errorDiv = document.getElementById("error-message");
            
            // Arată starea de încărcare
            document.getElementById("login-button").disabled = true;
            document.getElementById("login-button").textContent = "Logging in...";

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    var user = userCredential.user;

                    // Verifică dispozitivul curent
                    checkDevice(user);

                    // Dacă este prima dată când se loghează, salvează deviceID
                    var deviceID = getDeviceID();
                    var userRef = database.ref('users/' + user.uid);

                    userRef.once('value').then(function(snapshot) {
                        if (!snapshot.exists()) {
                            // Dacă nu există încă un dispozitiv salvat pentru utilizator, salvează-l
                            userRef.set({
                                deviceID: deviceID
                            });
                        }
                    });

                })
                .catch(function(error) {
                    var errorMessage = error.message;
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = "block";
                    
                    document.getElementById("login-button").disabled = false;
                    document.getElementById("login-button").textContent = "Login";
                });
        }

        // Handle enter key press
        function handleKeyPress(event) {
            if (event.keyCode === 13) {
                login();
            }
        }
    </script>
</head>
<body onload="checkAuthState()">
    <div class="login-container">
        <h1>Blackjack Strategy Calculator</h1>
        <form onsubmit="event.preventDefault();">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required onkeypress="handleKeyPress(event)">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required onkeypress="handleKeyPress(event)">
            </div>
            <button type="button" id="login-button" onclick="login()">Login</button>
            <div id="error-message" class="error-message"></div>
        </form>
    </div>
</body>
</html>
